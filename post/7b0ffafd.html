<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>畅购day09 | 小肥龙吃大冰淇淋</title><meta name="keywords" content="javase基础,商城"><meta name="author" content="小肥龙吃大冰淇淋"><meta name="copyright" content="小肥龙吃大冰淇淋"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第9章 Spring Security Oauth2 JWT学习目标 用户认证分析  单点登录  第三方登录  oauth2.0协议 oauth2.0认证模式	授权码授权模式	密码授权模式授权流程 用户认证授权   1 用户认证分析 上面流程图描述了用户要操作的各个微服务，用户查看个人信息需要访问客户微服务，下单需要访问订单微服务，秒杀抢购商品需要访问秒杀微服务。每个服务都需要认证用户的身份，身份">
<meta property="og:type" content="article">
<meta property="og:title" content="畅购day09">
<meta property="og:url" content="https://lvxueyangtiger.github.io/post/7b0ffafd.html">
<meta property="og:site_name" content="小肥龙吃大冰淇淋">
<meta property="og:description" content="第9章 Spring Security Oauth2 JWT学习目标 用户认证分析  单点登录  第三方登录  oauth2.0协议 oauth2.0认证模式	授权码授权模式	密码授权模式授权流程 用户认证授权   1 用户认证分析 上面流程图描述了用户要操作的各个微服务，用户查看个人信息需要访问客户微服务，下单需要访问订单微服务，秒杀抢购商品需要访问秒杀微服务。每个服务都需要认证用户的身份，身份">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212055.jpg">
<meta property="article:published_time" content="2021-12-08T07:27:00.000Z">
<meta property="article:modified_time" content="2022-11-27T09:16:45.831Z">
<meta property="article:author" content="小肥龙吃大冰淇淋">
<meta property="article:tag" content="javase基础">
<meta property="article:tag" content="商城">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212055.jpg"><link rel="shortcut icon" href="https://lvxueyangboke.oss-cn-beijing.aliyuncs.com/images/20210805191028.png"><link rel="canonical" href="https://lvxueyangtiger.github.io/post/7b0ffafd"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '畅购day09',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-27 17:16:45'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/ali_icon.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mogai.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="小肥龙吃大冰淇淋" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">303</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">108</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">73</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212055.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小肥龙吃大冰淇淋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">畅购day09</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-12-08T07:27:00.000Z" title="发表于 2021-12-08 15:27:00">2021-12-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-27T09:16:45.831Z" title="更新于 2022-11-27 17:16:45">2022-11-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java%E5%AD%A6%E4%B9%A0/">java学习</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java%E5%AD%A6%E4%B9%A0/%E7%95%85%E8%B4%AD/">畅购</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="畅购day09"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="第9章-Spring-Security-Oauth2-JWT"><a href="#第9章-Spring-Security-Oauth2-JWT" class="headerlink" title="第9章 Spring Security Oauth2 JWT"></a>第9章 Spring Security Oauth2 JWT</h1><h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2><ul>
<li><p>用户认证分析</p>
</li>
<li><p>单点登录</p>
</li>
<li><p>第三方登录</p>
</li>
<li><p>oauth2.0协议</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">oauth2.0认证模式</span><br><span class="line">	授权码授权模式</span><br><span class="line">	密码授权模式</span><br><span class="line">授权流程</span><br></pre></td></tr></table></figure></li>
<li><p>用户认证授权</p>
</li>
</ul>
<h2 id="1-用户认证分析"><a href="#1-用户认证分析" class="headerlink" title="1 用户认证分析"></a>1 用户认证分析</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164701.png" alt="1558173244406"></p>
<p>上面流程图描述了用户要操作的各个微服务，用户查看个人信息需要访问客户微服务，下单需要访问订单微服务，秒杀抢购商品需要访问秒杀微服务。每个服务都需要认证用户的身份，身份认证成功后，需要识别用户的角色然后授权访问对应的功能。</p>
<h3 id="1-1-认证与授权"><a href="#1-1-认证与授权" class="headerlink" title="1.1 认证与授权"></a>1.1 认证与授权</h3><p><strong>身份认证</strong></p>
<p>用户身份认证即用户去访问系统资源时系统要求验证用户的身份信息，身份合法方可继续访问。常见的用户身份认证表现形式有：用户名密码登录，指纹打卡等方式。说通俗点，就相当于校验用户账号密码是否正确。</p>
<p><strong>用户授权</strong></p>
<p>用户认证通过后去访问系统的资源，系统会判断用户是否拥有访问资源的权限，只允许访问有权限的系统资源，没有权限的资源将无法访问，这个过程叫用户授权。</p>
<h3 id="1-2-单点登录"><a href="#1-2-单点登录" class="headerlink" title="1.2 单点登录"></a>1.2 单点登录</h3><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164701.png" alt="1558173244406"></p>
<p>用户访问的项目中，至少有3个微服务需要识别用户身份，如果用户访问每个微服务都登录一次就太麻烦了，为了提高用户的体验，我们需要实现让用户在一个系统中登录，其他任意受信任的系统都可以访问，这个功能就叫单点登录。</p>
<p>单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。 SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统    </p>
<h3 id="1-3-第三方账号登录"><a href="#1-3-第三方账号登录" class="headerlink" title="1.3 第三方账号登录"></a>1.3 第三方账号登录</h3><h4 id="1-3-1-第三方登录介绍"><a href="#1-3-1-第三方登录介绍" class="headerlink" title="1.3.1 第三方登录介绍"></a>1.3.1 第三方登录介绍</h4><p>随着国内及国外巨头们的平台开放战略以及移动互联网的发展，第三方登录已经不是一个陌生的产品设计概念了。 所谓的第三方登录，是说基于用户在第三方平台上已有的账号和密码来快速完成己方应用的登录或者注册的功能。而这里的第三方平台，一般是已经拥有大量用户的平台，国外的比如Facebook，Twitter等，国内的比如微博、微信、QQ等。 </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164702.png" alt="1558174029075"></p>
<h4 id="1-3-2-第三方登录优点"><a href="#1-3-2-第三方登录优点" class="headerlink" title="1.3.2 第三方登录优点"></a>1.3.2 第三方登录优点</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.相比于本地注册，第三方登录一般来说比较方便、快捷，能够显著降低用户的注册和登录成本，方便用户实现快捷登录或注册。</span><br><span class="line">2.不用费尽心思地应付本地注册对账户名和密码的各种限制，如果不考虑昵称的重复性要求，几乎可以直接一个账号走遍天下，再也不用在大脑或者什么地方记住N多不同的网站或App的账号和密码，整个世界一下子清静了。</span><br><span class="line">3.在第一次绑定成功之后，之后用户便可以实现一键登录，使得后续的登录操作比起应用内的登录来容易了很多。</span><br><span class="line">4.对于某些喜欢社交，并希望将更多自己的生活内容展示给朋友的人来说，第三方登录可以实现把用户在应用内的活动同步到第三方平台上，省去了用户手动发布动态的麻烦。但对于某些比较注重个人隐私的用户来说，则会有一些担忧，所以龙哥所说的这个优点是有前提的。</span><br><span class="line">5.因为降低了用户的注册或登录成本，从而减少由于本地注册的繁琐性而带来的隐形用户流失，最终提高注册转化率。</span><br><span class="line">6.对于某些应用来说，使用第三方登录完全可以满足自己的需要，因此不必要设计和开发一套自己的账户体系。</span><br><span class="line">7.通过授权，可以通过在第三方平台上分享用户在应用内的活动在第三方平台上宣传自己，从而增加产品知名度。</span><br><span class="line">8.通过授权，可以获得该用户在第三方平台上的好友或粉丝等社交信息，从而后续可以针对用户的社交关系网进行有目的性的营销宣传，为产品的市场推广提供另一种渠道。</span><br></pre></td></tr></table></figure>



<h4 id="1-3-3-第三方认证"><a href="#1-3-3-第三方认证" class="headerlink" title="1.3.3 第三方认证"></a>1.3.3 第三方认证</h4><p>当需要访问第三方系统的资源时需要首先通过第三方系统的认证（例如：微信认证），由第三方系统对用户认证通过，并授权资源的访问权限。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164703.png" alt="1558174826405"></p>
<h2 id="2-认证技术方案"><a href="#2-认证技术方案" class="headerlink" title="2 认证技术方案"></a>2 认证技术方案</h2><h3 id="2-1-单点登录技术方案"><a href="#2-1-单点登录技术方案" class="headerlink" title="2.1 单点登录技术方案"></a>2.1 单点登录技术方案</h3><p>分布式系统要实现单点登录，通常将认证系统独立抽取出来，并且将用户身份信息存储在单独的存储介质，比如： MySQL、Redis，考虑性能要求，通常存储在Redis中，如下图：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164704.png" alt="1558175040643"></p>
<p>单点登录的特点是： </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、认证系统为独立的系统。 </span><br><span class="line">2、各子系统通过Http或其它协议与认证系统通信，完成用户认证。 </span><br><span class="line">3、用户身份信息存储在Redis集群。</span><br></pre></td></tr></table></figure>

<p> Java中有很多用户认证的框架都可以实现单点登录：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、Apache Shiro. </span><br><span class="line">2、CAS </span><br><span class="line">3、Spring security CAS    </span><br></pre></td></tr></table></figure>



<h3 id="2-2-Oauth2认证"><a href="#2-2-Oauth2认证" class="headerlink" title="2.2 Oauth2认证"></a>2.2 Oauth2认证</h3><p>OAuth（开放授权）是一个开放标准，允许用户授权第三方移动应用访问他们存储在另外的服务提供者上的信息，而不需要将用户名和密码提供给第三方移动应用或分享他们数据的所有内容，OAuth2.0是OAuth协议的延续版本。</p>
<h4 id="2-2-1-Oauth2认证流程"><a href="#2-2-1-Oauth2认证流程" class="headerlink" title="2.2.1 Oauth2认证流程"></a>2.2.1 Oauth2认证流程</h4><p>第三方认证技术方案最主要是解决认证协议的通用标准 问题，因为要实现 跨系统认证，各系统之间要遵循一定的接口协议。<br>OAUTH协议为用户资源的授权提供了一个安全的、开放而又简易的标准。同时，任何第三方都可以使用OAUTH认证服务，任何服务提供商都可以实现自身的OAUTH认证服务，因而OAUTH是开放的。业界提供了OAUTH的多种实现如PHP、JavaScript，Java，Ruby等各种语言开发包，大大节约了程序员的时间，因而OAUTH是简易的。互联网很多服务如Open API，很多大公司如Google，Yahoo，Microsoft等都提供了OAUTH认证服务，这些都足以说明OAUTH标准逐渐成为开放资源授权的标准。<br>Oauth协议目前发展到2.0版本，1.0版本过于复杂，2.0版本已得到广泛应用。<br>参考：<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/oAuth/7153134?fr=aladdin">https://baike.baidu.com/item/oAuth/7153134?fr=aladdin</a><br>Oauth协议：<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a><br>下边分析一个Oauth2认证的例子，黑马程序员网站使用微信认证的过程：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164705.png" alt="1562394786067"></p>
<p>1.客户端请求第三方授权</p>
<p>用户进入黑马程序的登录页面，点击微信的图标以微信账号登录系统，用户是自己在微信里信息的资源拥有者。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164706.png" alt="1558175450281"></p>
<p>点击“用QQ账号登录”出现一个二维码，此时用户扫描二维码，开始给黑马程序员授权。    </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164707.png" alt="1558175557482"></p>
<p>2.资源拥有者同意给客户端授权</p>
<p>​        资源拥有者扫描二维码表示资源拥有者同意给客户端授权，微信会对资源拥有者的身份进行验证， 验证通过后，QQ会询问用户是否给授权黑马程序员访问自己的QQ数据，用户点击“确认登录”表示同意授权，QQ认证服务器会 颁发一个授权码，并重定向到黑马程序员的网站。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164708.png" alt="1558175838653">    </p>
<p>3.客户端获取到授权码，请求认证服务器申请令牌 此过程用户看不到，客户端应用程序请求认证服务器，请求携带授权码。 </p>
<p>4.认证服务器向客户端响应令牌 认证服务器验证了客户端请求的授权码，如果合法则给客户端颁发令牌，令牌是客户端访问资源的通行证。 此交互过程用户看不到，当客户端拿到令牌后，用户在黑马程序员看到已经登录成功。 </p>
<p>5.客户端请求资源服务器的资源 客户端携带令牌访问资源服务器的资源。 黑马程序员网站携带令牌请求访问微信服务器获取用户的基本信息。 </p>
<p>6.资源服务器返回受保护资源 资源服务器校验令牌的合法性，如果合法则向用户响应资源信息内容。 注意：资源服务器和认证服务器可以是一个服务也可以分开的服务，如果是分开的服务资源服务器通常要请求认证 服务器来校验令牌的合法性。    </p>
<p>Oauth2.0认证流程如下： 引自Oauth2.0协议rfc6749 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a>    </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164709.png" alt="1558175981680"></p>
<p>Oauth2包括以下角色： </p>
<p>1、客户端 本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如：畅购在线Android客户端、畅购在 线Web客户端（浏览器端）、微信客户端等。 </p>
<p>2、资源拥有者 通常为用户，也可以是应用程序，即该资源的拥有者。 </p>
<p>3、授权服务器（也称认证服务器） 用来对资源拥有的身份进行认证、对访问资源进行授权。客户端要想访问资源需要通过认证服务器由资源拥有者授 权后方可访问。 </p>
<p>4、资源服务器 存储资源的服务器，比如，畅购网用户管理服务器存储了畅购网的用户信息等。客户端最终访问资源服务器获取资源信息。    </p>
<h4 id="2-2-2-Oauth2在项目的应用"><a href="#2-2-2-Oauth2在项目的应用" class="headerlink" title="2.2.2 Oauth2在项目的应用"></a>2.2.2 Oauth2在项目的应用</h4><p>Oauth2是一个标准的开放的授权协议，应用程序可以根据自己的要求去使用Oauth2，本项目计划使用Oauth2实现如 下目标：</p>
<p>1、畅购访问第三方系统的资源 </p>
<p>2、外部系统访问畅购的资源 </p>
<p>3、畅购前端（客户端） 访问畅购微服务的资源。 </p>
<p>4、畅购微服务之间访问资源，例如：微服务A访问微服务B的资源，B访问A的资源。</p>
<h3 id="2-3-Spring-security-Oauth2认证解决方案"><a href="#2-3-Spring-security-Oauth2认证解决方案" class="headerlink" title="2.3 Spring security Oauth2认证解决方案"></a>2.3 Spring security Oauth2认证解决方案</h3><p>本项目采用 Spring security + Oauth2完成用户认证及用户授权，Spring security 是一个强大的和高度可定制的身份验证和访问控制框架，Spring security 框架集成了Oauth2协议，下图是项目认证架构图：    </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164710.png" alt="1558176649652"></p>
<p>1、用户请求认证服务完成认证。 </p>
<p>2、认证服务下发用户身份令牌，拥有身份令牌表示身份合法。 </p>
<p>3、用户携带令牌请求资源服务，请求资源服务必先经过网关。 </p>
<p>4、网关校验用户身份令牌的合法，不合法表示用户没有登录，如果合法则放行继续访问。 </p>
<p>5、资源服务获取令牌，根据令牌完成授权。 </p>
<p>6、资源服务完成授权则响应资源信息。</p>
<h2 id="3-Security-Oauth2-0入门"><a href="#3-Security-Oauth2-0入门" class="headerlink" title="3 Security Oauth2.0入门"></a>3 Security Oauth2.0入门</h2><h3 id="3-1-学习知识点说明"><a href="#3-1-学习知识点说明" class="headerlink" title="3.1 学习知识点说明"></a>3.1 学习知识点说明</h3><p>本项目认证服务基于Spring Security Oauth2进行构建，并在其基础上作了一些扩展，采用JWT令牌机制，并自定 义了用户身份信息的内容。 本教程的主要目标是学习在项目中集成Spring Security Oauth2的方法和流程，通过 spring Security Oauth2的研究需要达到以下目标： </p>
<p>1、理解Oauth2的授权码认证流程及密码认证的流程。 </p>
<p>2、理解spring Security Oauth2的工作流程。 </p>
<p>3、掌握资源服务集成spring Security框架完成Oauth2认证的流程。</p>
<h3 id="3-2-搭建认证服务器"><a href="#3-2-搭建认证服务器" class="headerlink" title="3.2 搭建认证服务器"></a>3.2 搭建认证服务器</h3><h4 id="3-2-1-导入认证工程"><a href="#3-2-1-导入认证工程" class="headerlink" title="3.2.1 导入认证工程"></a>3.2.1 导入认证工程</h4><p>将课件中<code>day09\oauth2.0\changgou-user-oauth</code>的工程导入到项目中去，如下图：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164711.png" alt="1585040604663"></p>
<h4 id="3-2-2-application-yml配置"><a href="#3-2-2-application-yml配置" class="headerlink" title="3.2.2 application.yml配置"></a>3.2.2 application.yml配置</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">user-auth</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.211</span><span class="number">.132</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.211.132:3306/changgou_oauth?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowMultiQueries=true&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">allow-bean-definition-overriding:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:7001/eureka</span></span><br><span class="line"><span class="attr">auth:</span></span><br><span class="line">  <span class="attr">ttl:</span> <span class="number">3600</span>  <span class="comment">#token存储到redis的过期时间</span></span><br><span class="line">  <span class="attr">clientId:</span> <span class="string">changgou</span></span><br><span class="line">  <span class="attr">clientSecret:</span> <span class="string">changgou</span></span><br><span class="line">  <span class="attr">cookieDomain:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">cookieMaxAge:</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure>



<h4 id="3-2-2-启动授权认证服务"><a href="#3-2-2-启动授权认证服务" class="headerlink" title="3.2.2 启动授权认证服务"></a>3.2.2 启动授权认证服务</h4><p>启动之前，记得先启动eureka，再启动该授权认证工程。</p>
<h3 id="3-3-Oauth2授权模式"><a href="#3-3-Oauth2授权模式" class="headerlink" title="3.3 Oauth2授权模式"></a>3.3 Oauth2授权模式</h3><h4 id="3-3-1-Oauth2授权模式"><a href="#3-3-1-Oauth2授权模式" class="headerlink" title="3.3.1 Oauth2授权模式"></a>3.3.1 Oauth2授权模式</h4><p>Oauth2有以下授权模式： </p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">1.授权码模式（Authorization</span> <span class="string">Code）</span></span><br><span class="line"><span class="meta">2.隐式授权模式（Implicit）</span> <span class="string"></span></span><br><span class="line"><span class="meta">3.密码模式（Resource</span> <span class="string">Owner Password Credentials） </span></span><br><span class="line"><span class="meta">4.客户端模式（Client</span> <span class="string">Credentials） </span></span><br></pre></td></tr></table></figure>

<p>其中授权码模式和密码模式应用较多，本小节介绍授权码模式。</p>
<h4 id="3-3-2-授权码授权实现"><a href="#3-3-2-授权码授权实现" class="headerlink" title="3.3.2 授权码授权实现"></a>3.3.2 授权码授权实现</h4><p>上边例举的黑马程序员网站使用QQ认证的过程就是授权码模式，流程如下： </p>
<p>1、客户端请求第三方授权 </p>
<p>2、用户(资源拥有者)同意给客户端授权 </p>
<p>3、客户端获取到授权码，请求认证服务器申请 令牌 </p>
<p>4、认证服务器向客户端响应令牌 </p>
<p>5、客户端请求资源服务器的资源，资源服务校验令牌合法性，完成授权 </p>
<p>6、资源服务器返回受保护资源    </p>
<p><strong>(1)申请授权码</strong></p>
<p>请求认证服务获取授权码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get请求：</span><br><span class="line">http://localhost:9001/oauth/authorize?client_id=changgou&amp;response_type=code&amp;scop=app&amp;redirect_uri=http://localhost</span><br></pre></td></tr></table></figure>

<p>参数列表如下： </p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">client_id：客户端id，和授权配置类中设置的客户端id一致。</span> <span class="string"></span></span><br><span class="line"><span class="meta">response_type：授权码模式固定为code</span> <span class="string"></span></span><br><span class="line"><span class="meta">scop：客户端范围，和授权配置类中设置的scop一致。</span> <span class="string"></span></span><br><span class="line"><span class="attr">redirect_uri：跳转uri，当授权码申请成功后会跳转到此地址，并在后边带上code参数（授权码）</span></span><br></pre></td></tr></table></figure>

<p> 首先跳转到登录页面：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164712.png" alt="1565035634997"></p>
<p>输入账号和密码，账号随便填,例如szitheima，密码一定要叫做szitheima.(暂时写死，后面改造)</p>
<p>点击Sign in, Spring Security接收到请求会调用UserDetailsService接口的 方法进行调用并认证，只要认证通过即可进入授权页面，如下图，接下来进入授权页面：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164713.png" alt="1565035586067">   </p>
<p>点击Authorize,接下来返回授权码： 认证服务携带授权码跳转redirect_uri,code=k45iLY就是返回的授权码</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164714.png" alt="1558181855325"></p>
<p><strong>(2)申请令牌</strong></p>
<p>拿到授权码后，申请令牌。 Post请求：<a target="_blank" rel="noopener" href="http://localhost:9001/oauth/token">http://localhost:9001/oauth/token</a> 参数如下： </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grant_type：授权类型，填写authorization_code，表示授权码模式 </span><br><span class="line">code：授权码，就是刚刚获取的授权码，注意：授权码只使用一次就无效了，需要重新申请。 </span><br><span class="line">redirect_uri：申请授权码时的跳转url，一定和申请授权码时用的redirect_uri一致。 </span><br></pre></td></tr></table></figure>

<p>此链接需要使用 http Basic认证。 什么是http Basic认证？ http协议定义的一种认证方式，将客户端id和客户端密码按照“客户端ID:客户端密码”的格式拼接，并用base64编 码，放在header中请求服务端，一个例子： Authorization：Basic WGNXZWJBcHA6WGNXZWJBcHA=WGNXZWJBcHA6WGNXZWJBcHA= 是用户名:密码的base64编码。 认证失败服务端返回 401 Unauthorized。</p>
<p>以上测试使用postman完成： </p>
<p>http basic认证：    </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164715.png" alt="1558182132328"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164716.png" alt="1558182177167"></p>
<p>客户端Id和客户端密码会匹配数据库oauth_client_details表中的客户端id及客户端密码。    </p>
<p>点击发送： 申请令牌成功    </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164717.png"></p>
<p>返回信如下:</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">access_token：访问令牌，携带此令牌访问资源</span> <span class="string"></span></span><br><span class="line"><span class="meta">token_type：有MAC</span> <span class="string">Token与Bearer Token两种类型，两种的校验算法不同，RFC 6750建议Oauth2采用 Bearer Token（http://www.rfcreader.com/#rfc6750）。 </span></span><br><span class="line"><span class="meta">refresh_token：刷新令牌，使用此令牌可以延长访问令牌的过期时间。</span> <span class="string"></span></span><br><span class="line"><span class="meta">expires_in：过期时间，单位为秒。</span> <span class="string"></span></span><br><span class="line"><span class="meta">scope：范围，与定义的客户端范围一致。</span>    <span class="string"></span></span><br><span class="line"><span class="attr">jti：当前token的唯一标识</span></span><br></pre></td></tr></table></figure>



<p><strong>(3)令牌校验</strong></p>
<p>Spring Security Oauth2提供校验令牌的端点，如下： </p>
<p>Get: <a target="_blank" rel="noopener" href="http://localhost:9001/oauth/check_token?token=">http://localhost:9001/oauth/check_token?token=</a> [access_token]</p>
<p>参数： </p>
<p>token：令牌 </p>
<p>使用postman测试如下:</p>
<p> 1.填写如下图所示</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164718.png" alt="1585042410531"></p>
<p>2.发送请求测试</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164719.png" alt="1562409096845"></p>
<p>如果令牌校验失败，会出现如下结果：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164720.png" alt="1562409180948"></p>
<p>如果令牌过期了，会如下如下结果：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164721.png" alt="1562409507493"></p>
<p><strong>(4)刷新令牌</strong></p>
<p>刷新令牌是当令牌快过期时重新生成一个令牌，它于授权码授权和密码授权生成令牌不同，刷新令牌不需要授权码 也不需要账号和密码，只需要一个刷新令牌、客户端id和客户端密码。 </p>
<p>测试如下： Post：<a target="_blank" rel="noopener" href="http://localhost:9001/oauth/token">http://localhost:9001/oauth/token</a> </p>
<p>参数：    </p>
<p>grant_type： 固定为 refresh_token </p>
<p>refresh_token：刷新令牌（注意不是access_token，而是refresh_token）  </p>
<p>注意：</p>
<p>填写的时候不要有空格 ，另外也需要填写客户端新  </p>
<p>1）</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164718.png" alt="1585042410531"></p>
<p>2）</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164722.png" alt="1562409616911"></p>
<h4 id="3-3-3-密码授权实现"><a href="#3-3-3-密码授权实现" class="headerlink" title="3.3.3 密码授权实现"></a>3.3.3 密码授权实现</h4><p><strong>(1)认证</strong></p>
<p>密码模式（Resource Owner Password Credentials）与授权码模式的区别是申请令牌不再使用授权码，而是直接 通过用户名和密码即可申请令牌。 </p>
<p>测试如下： </p>
<p>Post请求：<a target="_blank" rel="noopener" href="http://localhost:9001/oauth/token">http://localhost:9001/oauth/token</a> </p>
<p>参数： </p>
<p>grant_type：密码模式授权填写password </p>
<p>username：账号 </p>
<p>password：密码 </p>
<p>并且此链接需要使用 http Basic认证。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164723.png" alt="1558221388787"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164724.png" alt="1558221423631"></p>
<p>测试数据如下：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164725.png" alt="1562462930730"></p>
<p><strong>(2)校验令牌</strong></p>
<p>Spring Security Oauth2提供校验令牌的端点，如下： </p>
<p>Get: <a target="_blank" rel="noopener" href="http://localhost:9001/oauth/check_token?token=">http://localhost:9001/oauth/check_token?token=</a> </p>
<p>参数： </p>
<p>token：令牌 </p>
<p>使用postman测试如下:</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164726.png" alt="1558221673028"></p>
<p>返回结果：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&#123;</span></span><br><span class="line">    <span class="meta">&quot;companyId&quot;</span>: <span class="string">null,</span></span><br><span class="line">    <span class="meta">&quot;userpic&quot;</span>: <span class="string">null,</span></span><br><span class="line">    <span class="meta">&quot;scope&quot;</span>: <span class="string">[</span></span><br><span class="line">        <span class="attr">&quot;app&quot;</span></span><br><span class="line">    <span class="attr">],</span></span><br><span class="line">    <span class="meta">&quot;name&quot;</span>: <span class="string">null,</span></span><br><span class="line">    <span class="meta">&quot;utype&quot;</span>: <span class="string">null,</span></span><br><span class="line">    <span class="meta">&quot;active&quot;</span>: <span class="string">true,</span></span><br><span class="line">    <span class="meta">&quot;id&quot;</span>: <span class="string">null,</span></span><br><span class="line">    <span class="meta">&quot;exp&quot;</span>: <span class="string">1990221534,</span></span><br><span class="line">    <span class="meta">&quot;jti&quot;</span>: <span class="string">&quot;5b96666e-436b-4301-91b5-d89f9bbe6edb&quot;,</span></span><br><span class="line">    <span class="meta">&quot;client_id&quot;</span>: <span class="string">&quot;changgou&quot;,</span></span><br><span class="line">    <span class="meta">&quot;user_name&quot;</span>: <span class="string">&quot;szitheima&quot;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>exp：过期时间，long类型，距离1970年的秒数（new Date().getTime()可得到当前时间距离1970年的毫秒数）。 </p>
<p>user_name： 用户名 </p>
<p>client_id：客户端Id，在oauth_client_details中配置 </p>
<p>scope：客户端范围，在oauth_client_details表中配置 </p>
<p>jti：与令牌对应的唯一标识 companyId、userpic、name、utype、</p>
<p>id：这些字段是本认证服务在Spring Security基础上扩展的用户身份信息    </p>
<p><strong>(3)刷新令牌</strong></p>
<p>刷新令牌是当令牌快过期时重新生成一个令牌，它于授权码授权和密码授权生成令牌不同，刷新令牌不需要授权码 也不需要账号和密码，只需要一个刷新令牌、客户端id和客户端密码。 </p>
<p>测试如下： Post：<a target="_blank" rel="noopener" href="http://localhost:9001/oauth/token">http://localhost:9001/oauth/token</a> </p>
<p>参数：    </p>
<p>grant_type： 固定为 refresh_token </p>
<p>refresh_token：刷新令牌（注意不是access_token，而是refresh_token）    </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164727.png" alt="1558221864957"></p>
<p>刷新令牌成功，会重新生成新的访问令牌和刷新令牌，令牌的有效期也比旧令牌长。 </p>
<p>刷新令牌通常是在令牌快过期时进行刷新 。</p>
<h2 id="4-资源服务授权"><a href="#4-资源服务授权" class="headerlink" title="4 资源服务授权"></a>4 资源服务授权</h2><h3 id="4-1-资源服务授权流程"><a href="#4-1-资源服务授权流程" class="headerlink" title="4.1 资源服务授权流程"></a>4.1 资源服务授权流程</h3><p>(1)传统授权流程</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164728.png" alt="1562479275302"></p>
<p>资源服务器授权流程如上图，客户端先去授权服务器申请令牌，申请令牌后，携带令牌访问资源服务器，资源服务器访问授权服务校验令牌的合法性，授权服务会返回校验结果，如果校验成功会返回用户信息给资源服务器，资源服务器如果接收到的校验结果通过了，则返回资源给客户端。</p>
<p>传统授权方法的问题是用户每次请求资源服务，资源服务都需要携带令牌访问认证服务去校验令牌的合法性，并根 据令牌获取用户的相关信息，性能低下。 </p>
<p>(2)公钥私钥授权流程</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164729.png" alt="1562406193809"></p>
<p>传统的授权模式性能低下，每次都需要请求授权服务校验令牌合法性，我们可以利用公钥私钥完成对令牌的加密，如果加密解密成功，则表示令牌合法，如果加密解密失败，则表示令牌无效不合法，合法则允许访问资源服务器的资源，解密失败，则不允许访问资源服务器资源。</p>
<p>上图的业务流程如下:</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">1、客户端请求认证服务申请令牌</span></span><br><span class="line"><span class="attr">2、认证服务生成令牌认证服务采用非对称加密算法，使用私钥生成令牌。</span></span><br><span class="line"><span class="meta">3、客户端携带令牌访问资源服务客户端在Http</span> <span class="string">header 中添加： Authorization：Bearer 令牌。</span></span><br><span class="line"><span class="attr">4、资源服务请求认证服务校验令牌的有效性资源服务接收到令牌，使用公钥校验令牌的合法性。</span></span><br><span class="line"><span class="attr">5、令牌有效，资源服务向客户端响应资源信息</span></span><br></pre></td></tr></table></figure>



<h3 id="4-2-公钥私钥"><a href="#4-2-公钥私钥" class="headerlink" title="4.2 公钥私钥"></a>4.2 公钥私钥</h3><p>在对称加密的时代，加密和解密用的是同一个密钥，这个密钥既用于加密，又用于解密。这样做有一个明显的缺点，如果两个人之间传输文件，两个人都要知道密钥，如果是三个人呢，五个人呢？于是就产生了非对称加密，用一个密钥进行加密（公钥），用另一个密钥进行解密（私钥）。</p>
<h4 id="4-2-1-公钥私钥原理"><a href="#4-2-1-公钥私钥原理" class="headerlink" title="4.2.1 公钥私钥原理"></a>4.2.1 公钥私钥原理</h4><p>张三有两把钥匙，一把是公钥，另一把是私钥。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164730.png" alt="1562470657125"></p>
<p>张三把公钥送给他的朋友们—-李四、王五、赵六—-每人一把。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164731.png" alt="1562470847506"></p>
<p>李四要给张三写一封保密的信。她写完后用张三的公钥加密，就可以达到保密的效果。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164732.png" alt="1562471063950"></p>
<p>张三收信后，用私钥解密，就看到了信件内容。这里要强调的是，只要张三的私钥不泄露，这封信就是安全的，即使落在别人手里，也无法解密。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164733.png" alt="1562471429501"></p>
<p>张三给李四回信，决定采用”数字签名”。他写完后先用Hash函数，生成信件的摘要（digest）。张三将这个签名，附在信件下面，一起发给李四。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164734.png" alt="1562472383322"></p>
<p>李四收信后，取下数字签名，用张三的公钥解密，得到信件的摘要。由此证明，这封信确实是张三发出的。李四再对信件本身使用Hash函数，将得到的结果，与上一步得到的摘要进行对比。如果两者一致，就证明这封信未被修改过。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164735.png" alt="1562472956514"></p>
<h4 id="4-2-2-生成私钥公钥"><a href="#4-2-2-生成私钥公钥" class="headerlink" title="4.2.2 生成私钥公钥"></a>4.2.2 生成私钥公钥</h4><p>Spring Security 提供对JWT的支持，本节我们使用Spring Security 提供的JwtHelper来创建JWT令牌，校验JWT令牌 等操作。 这里JWT令牌我们采用非对称算法进行加密，所以我们要先生成公钥和私钥。</p>
<p>(1)生成密钥证书 下边命令生成密钥证书，采用RSA 算法每个证书包含公钥和私钥 </p>
<p>创建一个文件夹，在该文件夹下执行如下命令行：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">keytool</span> <span class="string">-genkeypair -alias changgou -keyalg RSA -keypass changgou -keystore changgou.jks -storepass changgou </span></span><br></pre></td></tr></table></figure>

<p>Keytool 是一个java提供的证书管理工具 </p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">-alias：密钥的别名</span> <span class="string"></span></span><br><span class="line"><span class="meta">-keyalg：使用的hash算法</span> <span class="string"></span></span><br><span class="line"><span class="meta">-keypass：密钥的访问密码</span> <span class="string"></span></span><br><span class="line"><span class="meta">-keystore：密钥库文件名，xc.keystore保存了生成的证书</span> <span class="string"></span></span><br><span class="line"><span class="meta">-storepass：密钥库的访问密码</span> <span class="string"></span></span><br></pre></td></tr></table></figure>



<p>(2)查询证书信息</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">keytool</span> <span class="string">-list -keystore changgou.jks</span></span><br></pre></td></tr></table></figure>



<p>(3)删除别名 </p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">keytool</span> <span class="string">-delete -alias changgou -keystore changgou.jsk</span></span><br></pre></td></tr></table></figure>



<h4 id="4-2-3-导出公钥"><a href="#4-2-3-导出公钥" class="headerlink" title="4.2.3 导出公钥"></a>4.2.3 导出公钥</h4><p>openssl是一个加解密工具包，这里使用openssl来导出公钥信息。 </p>
<p>安装 openssl：<a target="_blank" rel="noopener" href="http://slproweb.com/products/Win32OpenSSL.html">http://slproweb.com/products/Win32OpenSSL.html</a> </p>
<p>安装资料目录下的Win64OpenSSL-1_1_0g.exe </p>
<p>配置openssl的path环境变量，如下图：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164736.png" alt="1565037190408"></p>
<p>本教程配置在C:\OpenSSL-Win64\bin</p>
<p>cmd进入changgou.jks文件所在目录执行如下命令(如下命令在windows下执行，会把-变成中文方式，请将它改成英文的-)： </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">keytool -list -rfc --keystore changgou.jks | openssl x509 -inform pem -pubkey</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164737.png" alt="1558222853425"></p>
<p>下面段内容是公钥</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">-----BEGIN</span> <span class="string">PUBLIC KEY-----</span></span><br><span class="line"><span class="attr">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvFsEiaLvij9C1Mz+oyAm</span></span><br><span class="line"><span class="attr">t47whAaRkRu/8kePM+X8760UGU0RMwGti6Z9y3LQ0RvK6I0brXmbGB/RsN38PVnh</span></span><br><span class="line"><span class="attr">cP8ZfxGUH26kX0RK+tlrxcrG+HkPYOH4XPAL8Q1lu1n9x3tLcIPxq8ZZtuIyKYEm</span></span><br><span class="line"><span class="attr">oLKyMsvTviG5flTpDprT25unWgE4md1kthRWXOnfWHATVY7Y/r4obiOL1mS5bEa/</span></span><br><span class="line"><span class="attr">iNKotQNnvIAKtjBM4RlIDWMa6dmz+lHtLtqDD2LF1qwoiSIHI75LQZ/CNYaHCfZS</span></span><br><span class="line"><span class="attr">xtOydpNKq8eb1/PGiLNolD4La2zf0/1dlcr5mkesV570NxRmU1tFm8Zd3MZlZmyv</span></span><br><span class="line"><span class="attr">9QIDAQAB</span></span><br><span class="line"><span class="meta">-----END</span> <span class="string">PUBLIC KEY-----</span></span><br></pre></td></tr></table></figure>

<p>将上边的公钥拷贝到文本public.key文件中，合并为一行,可以将它放到需要实现授权认证的工程中。</p>
<h4 id="4-2-4-JWT令牌"><a href="#4-2-4-JWT令牌" class="headerlink" title="4.2.4 JWT令牌"></a>4.2.4 JWT令牌</h4><p>(1)创建令牌数据</p>
<p>在changgou-user-oauth工程中创建测试类com.changgou.token.CreateJwtTest，使用它来创建令牌信息，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateJwtTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 创建令牌测试</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateToken</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//证书文件路径</span></span><br><span class="line">        String key_location=<span class="string">&quot;changgou.jks&quot;</span>;</span><br><span class="line">        <span class="comment">//秘钥库密码</span></span><br><span class="line">        String key_password=<span class="string">&quot;changgou&quot;</span>;</span><br><span class="line">        <span class="comment">//秘钥密码</span></span><br><span class="line">        String keypwd = <span class="string">&quot;changgou&quot;</span>;</span><br><span class="line">        <span class="comment">//秘钥别名</span></span><br><span class="line">        String alias = <span class="string">&quot;changgou&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//访问证书路径</span></span><br><span class="line">        ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(key_location);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建秘钥工厂</span></span><br><span class="line">        KeyStoreKeyFactory keyStoreKeyFactory = <span class="keyword">new</span> KeyStoreKeyFactory(resource,key_password.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取秘钥对(公钥、私钥)</span></span><br><span class="line">        KeyPair keyPair = keyStoreKeyFactory.getKeyPair(alias,keypwd.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取私钥</span></span><br><span class="line">        RSAPrivateKey rsaPrivate = (RSAPrivateKey) keyPair.getPrivate();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义Payload</span></span><br><span class="line">        Map&lt;String, Object&gt; tokenMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        tokenMap.put(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        tokenMap.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;itheima&quot;</span>);</span><br><span class="line">        tokenMap.put(<span class="string">&quot;roles&quot;</span>, <span class="string">&quot;ROLE_VIP,ROLE_USER&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成Jwt令牌</span></span><br><span class="line">        Jwt jwt = JwtHelper.encode(JSON.toJSONString(tokenMap), <span class="keyword">new</span> RsaSigner(rsaPrivate));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//取出令牌</span></span><br><span class="line">        String encoded = jwt.getEncoded();</span><br><span class="line">        System.out.println(encoded);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行后的结果如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlcyI6IlJPTEVfVklQLFJPTEVfVVNFUiIsIm5hbWUiOiJpdGhlaW1hIiwiaWQiOiIxIn0.IR9Qu9ZqYZ2gU2qgAziyT38UhEeL4Oi69ko-dzC_P9-Vjz40hwZDqxl8wZ-W2WAw1eWGIHV1EYDjg0-eilogJZ5UikyWw1bewXCpvlM-ZRtYQQqHFTlfDiVcFetyTayaskwa-x_BVS4pTWAskiaIKbKR4KcME2E5o1rEek-3YPkqAiZ6WP1UOmpaCJDaaFSdninqG0gzSCuGvLuG40x0Ngpfk7mPOecsIi5cbJElpdYUsCr9oXc53ROyfvYpHjzV7c2D5eIZu3leUPXRvvVAPJFEcSBiisxUSEeiGpmuQhaFZd1g-yJ1WQrixFvehMeLX2XU6W1nlL5ARTpQf_Jjiw</span></span><br></pre></td></tr></table></figure>



<p>(2)解析令牌</p>
<p>上面创建令牌后，我们可以对JWT令牌进行解析，这里解析需要用到公钥，我们可以将之前生成的公钥public.key拷贝出来用字符串变量token存储，然后通过公钥解密。</p>
<p>在changgou-user-oauth创建测试类com.changgou.token.ParseJwtTest实现解析校验令牌数据，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParseJwtTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 校验令牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testParseToken</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//令牌</span></span><br><span class="line">        String token = <span class="string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlcyI6IlJPTEVfVklQLFJPTEVfVVNFUiIsIm5hbWUiOiJpdGhlaW1hIiwiaWQiOiIxIn0.IR9Qu9ZqYZ2gU2qgAziyT38UhEeL4Oi69ko-dzC_P9-Vjz40hwZDqxl8wZ-W2WAw1eWGIHV1EYDjg0-eilogJZ5UikyWw1bewXCpvlM-ZRtYQQqHFTlfDiVcFetyTayaskwa-x_BVS4pTWAskiaIKbKR4KcME2E5o1rEek-3YPkqAiZ6WP1UOmpaCJDaaFSdninqG0gzSCuGvLuG40x0Ngpfk7mPOecsIi5cbJElpdYUsCr9oXc53ROyfvYpHjzV7c2D5eIZu3leUPXRvvVAPJFEcSBiisxUSEeiGpmuQhaFZd1g-yJ1WQrixFvehMeLX2XU6W1nlL5ARTpQf_Jjiw&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//公钥</span></span><br><span class="line">        String publickey = <span class="string">&quot;-----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvFsEiaLvij9C1Mz+oyAmt47whAaRkRu/8kePM+X8760UGU0RMwGti6Z9y3LQ0RvK6I0brXmbGB/RsN38PVnhcP8ZfxGUH26kX0RK+tlrxcrG+HkPYOH4XPAL8Q1lu1n9x3tLcIPxq8ZZtuIyKYEmoLKyMsvTviG5flTpDprT25unWgE4md1kthRWXOnfWHATVY7Y/r4obiOL1mS5bEa/iNKotQNnvIAKtjBM4RlIDWMa6dmz+lHtLtqDD2LF1qwoiSIHI75LQZ/CNYaHCfZSxtOydpNKq8eb1/PGiLNolD4La2zf0/1dlcr5mkesV570NxRmU1tFm8Zd3MZlZmyv9QIDAQAB-----END PUBLIC KEY-----&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//校验Jwt</span></span><br><span class="line">        Jwt jwt = JwtHelper.decodeAndVerify(token, <span class="keyword">new</span> RsaVerifier(publickey));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取Jwt原始内容</span></span><br><span class="line">        String claims = jwt.getClaims();</span><br><span class="line">        System.out.println(claims);</span><br><span class="line">        <span class="comment">//jwt令牌</span></span><br><span class="line">        String encoded = jwt.getEncoded();</span><br><span class="line">        System.out.println(encoded);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行后的结果如下：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164738.png" alt="1562478682563"></p>
<h2 id="5-认证开发"><a href="#5-认证开发" class="headerlink" title="5 认证开发"></a>5 认证开发</h2><h3 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a>5.1 需求分析</h3><p>用户登录的流程图如下：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164739.png" alt="1579596116131"></p>
<p>执行流程： </p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">1、用户在登录页面中进行登录，请求认证服务</span> <span class="string">，认证服务一是客户端二是认证服务期。</span></span><br><span class="line"><span class="attr">2、认证服务认证通过，生成jwt令牌，将jwt令牌及相关信息写入cookie</span></span><br><span class="line"><span class="meta">3、用户访通过网关访问微服务1（资源服务器），带着cookie到网关</span> <span class="string"></span></span><br><span class="line"><span class="meta">4、网关从cookie获取token，如果存在token，则校验token合法性，如果不合法则拒绝访问，否则放行</span> <span class="string"></span></span><br></pre></td></tr></table></figure>



<h3 id="5-2-认证服务"><a href="#5-2-认证服务" class="headerlink" title="5.2 认证服务"></a>5.2 认证服务</h3><h4 id="5-2-1-认证需求分析"><a href="#5-2-1-认证需求分析" class="headerlink" title="5.2.1 认证需求分析"></a>5.2.1 认证需求分析</h4><p>认证服务需要实现的功能如下： </p>
<p>1、登录接口 </p>
<p>前端post或者是get请求提交账号、密码等，用户身份校验通过，生成令牌，并将令牌写入cookie。 </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164740.png" alt="1558224020588"></p>
<h4 id="5-2-2-工具封装"><a href="#5-2-2-工具封装" class="headerlink" title="5.2.2 工具封装"></a>5.2.2 工具封装</h4><p>在changgou-user-oauth工程中添加如下工具对象，方便操作令牌信息。</p>
<p>创建com.changgou.oauth.util.AuthToken类，存储用户令牌数据，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthToken</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//令牌信息</span></span><br><span class="line">    String accessToken;</span><br><span class="line">    <span class="comment">//刷新token(refresh_token)</span></span><br><span class="line">    String refreshToken;</span><br><span class="line">    <span class="comment">//jwt短令牌</span></span><br><span class="line">    String jti;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...get...set</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建com.changgou.oauth.util.CookieUtil类，操作Cookie,代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CookieUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置cookie</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name     cookie名字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value    cookie值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maxAge   cookie生命周期 以秒为单位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addCookie</span><span class="params">(HttpServletResponse response, String domain, String path, String name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 String value, <span class="keyword">int</span> maxAge, <span class="keyword">boolean</span> httpOnly)</span> </span>&#123;</span><br><span class="line">        Cookie cookie = <span class="keyword">new</span> Cookie(name, value);</span><br><span class="line">        cookie.setDomain(domain);</span><br><span class="line">        cookie.setPath(path);</span><br><span class="line">        cookie.setMaxAge(maxAge);</span><br><span class="line">        cookie.setHttpOnly(httpOnly);</span><br><span class="line">        response.addCookie(cookie);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据cookie名称读取cookie</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> map&lt;cookieName,cookieValue&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String,String&gt; <span class="title">readCookie</span><span class="params">(HttpServletRequest request, String ... cookieNames)</span> </span>&#123;</span><br><span class="line">        Map&lt;String,String&gt; cookieMap = <span class="keyword">new</span> HashMap&lt;String,String&gt;();</span><br><span class="line">            Cookie[] cookies = request.getCookies();</span><br><span class="line">            <span class="keyword">if</span> (cookies != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Cookie cookie : cookies) &#123;</span><br><span class="line">                    String cookieName = cookie.getName();</span><br><span class="line">                    String cookieValue = cookie.getValue();</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;cookieNames.length;i++)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(cookieNames[i].equals(cookieName))&#123;</span><br><span class="line">                            cookieMap.put(cookieName,cookieValue);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> cookieMap;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="5-2-3-业务层"><a href="#5-2-3-业务层" class="headerlink" title="5.2.3  业务层"></a>5.2.3  业务层</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164741.png" alt="1562486044874"></p>
<p>如上图，我们现在实现一个认证流程，用户从页面输入账号密码，到认证服务的Controller层，Controller层调用Service层，Service层调用OAuth2.0的认证地址，进行密码授权认证操作，如果账号密码正确了，就返回令牌信息给Service层，Service将令牌信息给Controller层，Controller层将数据存入到Cookie中，再响应用户。</p>
<p>创建com.changgou.oauth.service.AuthService接口，并添加授权认证方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 授权认证方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">AuthToken <span class="title">login</span><span class="params">(String username, String password, String clientId, String clientSecret)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建com.changgou.oauth.service.impl.AuthServiceImpl实现类，实现获取令牌数据，这里认证获取令牌采用的是密码授权模式，用的是RestTemplate向OAuth服务发起认证请求，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthServiceImpl</span> <span class="keyword">implements</span> <span class="title">AuthService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancerClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 授权认证方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientSecret</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthToken <span class="title">login</span><span class="params">(String username, String password, String clientId, String clientSecret)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//申请令牌</span></span><br><span class="line">        AuthToken authToken = applyToken(username,password,clientId, clientSecret);</span><br><span class="line">        <span class="keyword">if</span>(authToken == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;申请令牌失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> authToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/****</span></span><br><span class="line"><span class="comment">     * 认证方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username:用户登录名字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password：用户密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientId：配置文件中的客户端ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientSecret：配置文件中的秘钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> AuthToken <span class="title">applyToken</span><span class="params">(String username, String password, String clientId, String clientSecret)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//选中认证服务的地址</span></span><br><span class="line">        ServiceInstance serviceInstance = loadBalancerClient.choose(<span class="string">&quot;user-auth&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (serviceInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;找不到对应的服务&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取令牌的url</span></span><br><span class="line">        String path = serviceInstance.getUri().toString() + <span class="string">&quot;/oauth/token&quot;</span>;</span><br><span class="line">        <span class="comment">//定义body</span></span><br><span class="line">        MultiValueMap&lt;String, String&gt; formData = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        <span class="comment">//授权方式</span></span><br><span class="line">        formData.add(<span class="string">&quot;grant_type&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">        <span class="comment">//账号</span></span><br><span class="line">        formData.add(<span class="string">&quot;username&quot;</span>, username);</span><br><span class="line">        <span class="comment">//密码</span></span><br><span class="line">        formData.add(<span class="string">&quot;password&quot;</span>, password);</span><br><span class="line">        <span class="comment">//定义头</span></span><br><span class="line">        MultiValueMap&lt;String, String&gt; header = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        header.add(<span class="string">&quot;Authorization&quot;</span>, httpbasic(clientId, clientSecret));</span><br><span class="line">        <span class="comment">//指定 restTemplate当遇到400或401响应时候也不要抛出异常，也要正常返回值</span></span><br><span class="line">        restTemplate.setErrorHandler(<span class="keyword">new</span> DefaultResponseErrorHandler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleError</span><span class="params">(ClientHttpResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="comment">//当响应的值为400或401时候也要正常响应，不要抛出异常</span></span><br><span class="line">                <span class="keyword">if</span> (response.getRawStatusCode() != <span class="number">400</span> &amp;&amp; response.getRawStatusCode() != <span class="number">401</span>) &#123;</span><br><span class="line">                    <span class="keyword">super</span>.handleError(response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Map map = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//http请求spring security的申请令牌接口</span></span><br><span class="line">            ResponseEntity&lt;Map&gt; mapResponseEntity = restTemplate.exchange(path, HttpMethod.POST,<span class="keyword">new</span> HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt;(formData, header), Map.class);</span><br><span class="line">            <span class="comment">//获取响应数据</span></span><br><span class="line">            map = mapResponseEntity.getBody();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RestClientException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(map == <span class="keyword">null</span> || map.get(<span class="string">&quot;access_token&quot;</span>) == <span class="keyword">null</span> || map.get(<span class="string">&quot;refresh_token&quot;</span>) == <span class="keyword">null</span> || map.get(<span class="string">&quot;jti&quot;</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//jti是jwt令牌的唯一标识作为用户身份令牌</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;创建令牌失败！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将响应数据封装成AuthToken对象</span></span><br><span class="line">        AuthToken authToken = <span class="keyword">new</span> AuthToken();</span><br><span class="line">        <span class="comment">//访问令牌(jwt)</span></span><br><span class="line">        String accessToken = (String) map.get(<span class="string">&quot;access_token&quot;</span>);</span><br><span class="line">        <span class="comment">//刷新令牌(jwt)</span></span><br><span class="line">        String refreshToken = (String) map.get(<span class="string">&quot;refresh_token&quot;</span>);</span><br><span class="line">        <span class="comment">//jti，作为用户的身份标识</span></span><br><span class="line">        String jwtToken= (String) map.get(<span class="string">&quot;jti&quot;</span>);</span><br><span class="line">        authToken.setJti(jwtToken);</span><br><span class="line">        authToken.setAccessToken(accessToken);</span><br><span class="line">        authToken.setRefreshToken(refreshToken);</span><br><span class="line">        <span class="keyword">return</span> authToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * base64编码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientSecret</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">httpbasic</span><span class="params">(String clientId,String clientSecret)</span></span>&#123;</span><br><span class="line">        <span class="comment">//将客户端id和客户端密码拼接，按“客户端id:客户端密码”</span></span><br><span class="line">        String string = clientId+<span class="string">&quot;:&quot;</span>+clientSecret;</span><br><span class="line">        <span class="comment">//进行base64编码</span></span><br><span class="line">        <span class="keyword">byte</span>[] encode = Base64Utils.encode(string.getBytes());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Basic &quot;</span>+<span class="keyword">new</span> String(encode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="5-2-4-控制层"><a href="#5-2-4-控制层" class="headerlink" title="5.2.4  控制层"></a>5.2.4  控制层</h4><p>创建控制层com.changgou.oauth.controller.AuthController，编写用户登录授权方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//客户端ID</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;auth.clientId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String clientId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//秘钥</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;auth.clientSecret&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String clientSecret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Cookie存储的域名</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;auth.cookieDomain&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String cookieDomain;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Cookie生命周期</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;auth.cookieMaxAge&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> cookieMaxAge;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AuthService authService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">login</span><span class="params">(String username, String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(username))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;用户名不允许为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(password))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;密码不允许为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//申请令牌</span></span><br><span class="line">        AuthToken authToken =  authService.login(username,password,clientId,clientSecret);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用户身份令牌</span></span><br><span class="line">        String access_token = authToken.getAccessToken();</span><br><span class="line">        <span class="comment">//将令牌存储到cookie</span></span><br><span class="line">        saveCookie(access_token);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK,<span class="string">&quot;登录成功！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 将令牌存储到cookie</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveCookie</span><span class="params">(String token)</span></span>&#123;</span><br><span class="line">        HttpServletResponse response = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getResponse();</span><br><span class="line">        CookieUtil.addCookie(response,cookieDomain,<span class="string">&quot;/&quot;</span>,<span class="string">&quot;Authorization&quot;</span>,token,cookieMaxAge,<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="5-2-5-测试认证接口"><a href="#5-2-5-测试认证接口" class="headerlink" title="5.2.5 测试认证接口"></a>5.2.5 测试认证接口</h4><p>使用postman测试：</p>
<p> Post/get请求：<a target="_blank" rel="noopener" href="http://localhost:9001/user/login">http://localhost:9001/user/login</a>    </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209164742.png" alt="1562489532494"></p>
<p>注意：<code>不要使用basic authorization进行设置，否则会报错</code>。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">小肥龙吃大冰淇淋</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lvxueyangtiger.github.io/post/7b0ffafd.html">https://lvxueyangtiger.github.io/post/7b0ffafd.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lvxueyangtiger.github.io" target="_blank">小肥龙吃大冰淇淋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/javase%E5%9F%BA%E7%A1%80/">javase基础</a><a class="post-meta__tags" href="/tags/%E5%95%86%E5%9F%8E/">商城</a></div><div class="post_share"><div class="social-share" data-image="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212055.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/c08ca6b.html"><img class="prev-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082159.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">畅购day08</div></div></a></div><div class="next-post pull-right"><a href="/post/ff7d07a2.html"><img class="next-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082319.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">传智健康day02</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/1bc87318.html" title="畅购day10"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212120.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">畅购day10</div></div></a></div><div><a href="/post/6ccf438e.html" title="畅购day11"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212035.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">畅购day11</div></div></a></div><div><a href="/post/f5c61234.html" title="畅购day12"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082249.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">畅购day12</div></div></a></div><div><a href="/post/82c122a2.html" title="畅购day13"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082121.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">畅购day13</div></div></a></div><div><a href="/post/1ca5b701.html" title="畅购day14"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212050.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">畅购day14</div></div></a></div><div><a href="/post/6ba28797.html" title="畅购day15"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082055.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">畅购day15</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC9%E7%AB%A0-Spring-Security-Oauth2-JWT"><span class="toc-number">1.</span> <span class="toc-text">第9章 Spring Security Oauth2 JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">1 用户认证分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 认证与授权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 单点登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%AC%AC%E4%B8%89%E6%96%B9%E8%B4%A6%E5%8F%B7%E7%99%BB%E5%BD%95"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 第三方账号登录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1-%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">1.3.1 第三方登录介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95%E4%BC%98%E7%82%B9"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">1.3.2 第三方登录优点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-3-%E7%AC%AC%E4%B8%89%E6%96%B9%E8%AE%A4%E8%AF%81"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">1.3.3 第三方认证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%AE%A4%E8%AF%81%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.</span> <span class="toc-text">2 认证技术方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 单点登录技术方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Oauth2%E8%AE%A4%E8%AF%81"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 Oauth2认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-Oauth2%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">2.2.1 Oauth2认证流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-Oauth2%E5%9C%A8%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2.2.2 Oauth2在项目的应用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Spring-security-Oauth2%E8%AE%A4%E8%AF%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 Spring security Oauth2认证解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Security-Oauth2-0%E5%85%A5%E9%97%A8"><span class="toc-number">1.4.</span> <span class="toc-text">3 Security Oauth2.0入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%AD%A6%E4%B9%A0%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%B4%E6%98%8E"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 学习知识点说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%90%AD%E5%BB%BA%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 搭建认证服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E5%AF%BC%E5%85%A5%E8%AE%A4%E8%AF%81%E5%B7%A5%E7%A8%8B"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">3.2.1 导入认证工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-application-yml%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">3.2.2 application.yml配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E5%90%AF%E5%8A%A8%E6%8E%88%E6%9D%83%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">3.2.2 启动授权认证服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Oauth2%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.3 Oauth2授权模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-Oauth2%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">3.3.1 Oauth2授权模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-%E6%8E%88%E6%9D%83%E7%A0%81%E6%8E%88%E6%9D%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">3.3.2 授权码授权实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-3-%E5%AF%86%E7%A0%81%E6%8E%88%E6%9D%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">3.3.3 密码授权实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E6%8E%88%E6%9D%83"><span class="toc-number">1.5.</span> <span class="toc-text">4 资源服务授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 资源服务授权流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%85%AC%E9%92%A5%E7%A7%81%E9%92%A5"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.2 公钥私钥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-%E5%85%AC%E9%92%A5%E7%A7%81%E9%92%A5%E5%8E%9F%E7%90%86"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">4.2.1 公钥私钥原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-%E7%94%9F%E6%88%90%E7%A7%81%E9%92%A5%E5%85%AC%E9%92%A5"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">4.2.2 生成私钥公钥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-%E5%AF%BC%E5%87%BA%E5%85%AC%E9%92%A5"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">4.2.3 导出公钥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-4-JWT%E4%BB%A4%E7%89%8C"><span class="toc-number">1.5.2.4.</span> <span class="toc-text">4.2.4 JWT令牌</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E8%AE%A4%E8%AF%81%E5%BC%80%E5%8F%91"><span class="toc-number">1.6.</span> <span class="toc-text">5 认证开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">1.6.1.</span> <span class="toc-text">5.1 需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.6.2.</span> <span class="toc-text">5.2 认证服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-%E8%AE%A4%E8%AF%81%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">5.2.1 认证需求分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-%E5%B7%A5%E5%85%B7%E5%B0%81%E8%A3%85"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">5.2.2 工具封装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-3-%E4%B8%9A%E5%8A%A1%E5%B1%82"><span class="toc-number">1.6.2.3.</span> <span class="toc-text">5.2.3  业务层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-4-%E6%8E%A7%E5%88%B6%E5%B1%82"><span class="toc-number">1.6.2.4.</span> <span class="toc-text">5.2.4  控制层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-5-%E6%B5%8B%E8%AF%95%E8%AE%A4%E8%AF%81%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.6.2.5.</span> <span class="toc-text">5.2.5 测试认证接口</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 小肥龙吃大冰淇淋</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="framework-info"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202301132049386.png"/><span> </span><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/">晋ICP备2022012091号-1</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'pinglun-9gh2lmcnd8587831',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'pinglun-9gh2lmcnd8587831',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-theme-volantis@latest/source/js/issues.min.js"></script><script src="//code.tidio.co/smwivpnwumemac2wohardi3d3gpud1ag.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>